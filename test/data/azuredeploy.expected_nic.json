{"$schema": "https://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#", "contentVersion": "1.0.0.0", "parameters": {"agentpool1Count": {"allowedValues": [1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23, 24, 25, 26, 27, 28, 29, 30, 31, 32, 33, 34, 35, 36, 37, 38, 39, 40, 41, 42, 43, 44, 45, 46, 47, 48, 49, 50, 51, 52, 53, 54, 55, 56, 57, 58, 59, 60, 61, 62, 63, 64, 65, 66, 67, 68, 69, 70, 71, 72, 73, 74, 75, 76, 77, 78, 79, 80, 81, 82, 83, 84, 85, 86, 87, 88, 89, 90, 91, 92, 93, 94, 95, 96, 97, 98, 99, 100], "defaultValue": 1, "metadata": {"description": "The number of agents for the cluster.  This value can be from 1 to 100"}, "type": "int"}, "agentpool1Offset": {"allowedValues": [0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23, 24, 25, 26, 27, 28, 29, 30, 31, 32, 33, 34, 35, 36, 37, 38, 39, 40, 41, 42, 43, 44, 45, 46, 47, 48, 49, 50, 51, 52, 53, 54, 55, 56, 57, 58, 59, 60, 61, 62, 63, 64, 65, 66, 67, 68, 69, 70, 71, 72, 73, 74, 75, 76, 77, 78, 79, 80, 81, 82, 83, 84, 85, 86, 87, 88, 89, 90, 91, 92, 93, 94, 95, 96, 97, 98, 99], "defaultValue": 0, "metadata": {"description": "The offset into the agent pool where to start creating agents.  This value can be from 0 to 99, but must be less than agentCount"}, "type": "int"}, "agentpool1Subnet": {"defaultValue": "10.240.0.0/16", "metadata": {"description": "Sets the subnet of agent pool 'agentpool1'."}, "type": "string"}, "agentpool1VMSize": {"allowedValues": ["Standard_A0", "Standard_A1", "Standard_A10", "Standard_A11", "Standard_A1_v2", "Standard_A2", "Standard_A2_v2", "Standard_A2m_v2", "Standard_A3", "Standard_A4", "Standard_A4_v2", "Standard_A4m_v2", "Standard_A5", "Standard_A6", "Standard_A7", "Standard_A8", "Standard_A8_v2", "Standard_A8m_v2", "Standard_A9", "Standard_D1", "Standard_D11", "Standard_D11_v2", "Standard_D11_v2_Promo", "Standard_D12", "Standard_D12_v2", "Standard_D12_v2_Promo", "Standard_D13", "Standard_D13_v2", "Standard_D13_v2_Promo", "Standard_D14", "Standard_D14_v2", "Standard_D14_v2_Promo", "Standard_D15_v2", "Standard_D1_v2", "Standard_D2", "Standard_D2_v2", "Standard_D2_v2_Promo", "Standard_D3", "Standard_D3_v2", "Standard_D3_v2_Promo", "Standard_D4", "Standard_D4_v2", "Standard_D4_v2_Promo", "Standard_D5_v2", "Standard_D5_v2_Promo", "Standard_DS1", "Standard_DS11", "Standard_DS11_v2", "Standard_DS11_v2_Promo", "Standard_DS12", "Standard_DS12_v2", "Standard_DS12_v2_Promo", "Standard_DS13", "Standard_DS13_v2", "Standard_DS13_v2_Promo", "Standard_DS14", "Standard_DS14_v2", "Standard_DS14_v2_Promo", "Standard_DS15_v2", "Standard_DS1_v2", "Standard_DS2", "Standard_DS2_v2", "Standard_DS2_v2_Promo", "Standard_DS3", "Standard_DS3_v2", "Standard_DS3_v2_Promo", "Standard_DS4", "Standard_DS4_v2", "Standard_DS4_v2_Promo", "Standard_DS5_v2", "Standard_DS5_v2_Promo", "Standard_F1", "Standard_F16", "Standard_F16s", "Standard_F1s", "Standard_F2", "Standard_F2s", "Standard_F4", "Standard_F4s", "Standard_F8", "Standard_F8s", "Standard_G1", "Standard_G2", "Standard_G3", "Standard_G4", "Standard_G5", "Standard_GS1", "Standard_GS2", "Standard_GS3", "Standard_GS4", "Standard_GS5", "Standard_H16", "Standard_H16m", "Standard_H16mr", "Standard_H16r", "Standard_H8", "Standard_H8m", "Standard_L16s", "Standard_L32s", "Standard_L4s", "Standard_L8s", "Standard_M128ms", "Standard_M128s", "Standard_M64ms", "Standard_NC12", "Standard_NC24", "Standard_NC24r", "Standard_NC6", "Standard_NV12", "Standard_NV24", "Standard_NV6"], "defaultValue": "Standard_D2_v2", "metadata": {"description": "The size of the Virtual Machine."}, "type": "string"}, "apiServerCertificate": {"metadata": {"description": "The base 64 server certificate used on the master"}, "type": "string"}, "apiServerPrivateKey": {"metadata": {"description": "The base 64 server private key used on the master."}, "type": "securestring"}, "caCertificate": {"metadata": {"description": "The base 64 certificate authority certificate"}, "type": "string"}, "clientCertificate": {"metadata": {"description": "The base 64 client certificate used to communicate with the master"}, "type": "string"}, "clientPrivateKey": {"metadata": {"description": "The base 64 client private key used to communicate with the master"}, "type": "securestring"}, "dockerEngineDownloadRepo": {"defaultValue": "https://aptdocker.azureedge.net/repo", "metadata": {"description": "The docker engine download url for kubernetes."}, "type": "string"}, "firstConsecutiveStaticIP": {"defaultValue": "10.240.255.5", "metadata": {"description": "Sets the static IP of the first master"}, "type": "string"}, "kubeClusterCidr": {"metadata": {"description": "Kubernetes cluster subnet"}, "type": "string"}, "kubeConfigCertificate": {"metadata": {"description": "The base 64 certificate used by cli to communicate with the master"}, "type": "string"}, "kubeConfigPrivateKey": {"metadata": {"description": "The base 64 private key used by cli to communicate with the master"}, "type": "securestring"}, "kubernetesAddonManagerSpec": {"defaultValue": "", "metadata": {"description": "The container spec for hyperkube."}, "type": "string"}, "kubernetesAddonResizerSpec": {"defaultValue": "", "metadata": {"description": "The container spec for addon-resizer."}, "type": "string"}, "kubernetesDNSMasqSpec": {"defaultValue": "", "metadata": {"description": "The container spec for kube-dnsmasq-amd64."}, "type": "string"}, "kubernetesDashboardSpec": {"defaultValue": "", "metadata": {"description": "The container spec for kubernetes-dashboard-amd64."}, "type": "string"}, "kubernetesExecHealthzSpec": {"defaultValue": "", "metadata": {"description": "The container spec for exechealthz-amd64."}, "type": "string"}, "kubernetesHeapsterSpec": {"defaultValue": "", "metadata": {"description": "The container spec for heapster."}, "type": "string"}, "kubernetesHyperkubeSpec": {"defaultValue": "", "metadata": {"description": "The container spec for hyperkube."}, "type": "string"}, "kubernetesKubeDNSSpec": {"defaultValue": "", "metadata": {"description": "The container spec for kubedns-amd64."}, "type": "string"}, "kubernetesPodInfraContainerSpec": {"defaultValue": "", "metadata": {"description": "The container spec for pod infra."}, "type": "string"}, "linuxAdminUsername": {"metadata": {"description": "User name for the Linux Virtual Machines (SSH or Password)."}, "type": "string"}, "location": {"defaultValue": "", "metadata": {"description": "Sets the location for all resources in the cluster"}, "type": "string"}, "masterEndpointDNSNamePrefix": {"metadata": {"description": "Sets the Domain name label for the master IP Address.  The concatenation of the domain name label and the regional DNS zone make up the fully qualified domain name associated with the public IP address."}, "type": "string"}, "masterOffset": {"allowedValues": [0, 1, 2, 3, 4], "defaultValue": 0, "metadata": {"description": "The offset into the master pool where to start creating master VMs.  This value can be from 0 to 4, but must be less than masterCount."}, "type": "int"}, "masterSubnet": {"defaultValue": "10.240.0.0/16", "metadata": {"description": "Sets the subnet of the master node(s)."}, "type": "string"}, "masterVMSize": {"allowedValues": ["Standard_A10", "Standard_A11", "Standard_A2", "Standard_A2_v2", "Standard_A2m_v2", "Standard_A3", "Standard_A4", "Standard_A4_v2", "Standard_A4m_v2", "Standard_A5", "Standard_A6", "Standard_A7", "Standard_A8", "Standard_A8_v2", "Standard_A8m_v2", "Standard_A9", "Standard_D11", "Standard_D11_v2", "Standard_D11_v2_Promo", "Standard_D12", "Standard_D12_v2", "Standard_D12_v2_Promo", "Standard_D13", "Standard_D13_v2", "Standard_D13_v2_Promo", "Standard_D14", "Standard_D14_v2", "Standard_D14_v2_Promo", "Standard_D15_v2", "Standard_D2", "Standard_D2_v2", "Standard_D2_v2_Promo", "Standard_D3", "Standard_D3_v2", "Standard_D3_v2_Promo", "Standard_D4", "Standard_D4_v2", "Standard_D4_v2_Promo", "Standard_D5_v2", "Standard_D5_v2_Promo", "Standard_DS11", "Standard_DS11_v2", "Standard_DS11_v2_Promo", "Standard_DS12", "Standard_DS12_v2", "Standard_DS12_v2_Promo", "Standard_DS13", "Standard_DS13_v2", "Standard_DS13_v2_Promo", "Standard_DS14", "Standard_DS14_v2", "Standard_DS14_v2_Promo", "Standard_DS15_v2", "Standard_DS2", "Standard_DS2_v2", "Standard_DS2_v2_Promo", "Standard_DS3", "Standard_DS3_v2", "Standard_DS3_v2_Promo", "Standard_DS4", "Standard_DS4_v2", "Standard_DS4_v2_Promo", "Standard_DS5_v2", "Standard_DS5_v2_Promo", "Standard_F16", "Standard_F16s", "Standard_F2", "Standard_F2s", "Standard_F4", "Standard_F4s", "Standard_F8", "Standard_F8s", "Standard_G1", "Standard_G2", "Standard_G3", "Standard_G4", "Standard_G5", "Standard_GS1", "Standard_GS2", "Standard_GS3", "Standard_GS4", "Standard_GS5", "Standard_H16", "Standard_H16m", "Standard_H16mr", "Standard_H16r", "Standard_H8", "Standard_H8m", "Standard_L16s", "Standard_L32s", "Standard_L4s", "Standard_L8s", "Standard_M128ms", "Standard_M128s", "Standard_M64ms", "Standard_NC12", "Standard_NC24", "Standard_NC24r", "Standard_NC6", "Standard_NV12", "Standard_NV24", "Standard_NV6"], "metadata": {"description": "The size of the Virtual Machine."}, "type": "string"}, "nameSuffix": {"defaultValue": "68327745", "metadata": {"description": "A string hash of the master DNS name to uniquely identify the cluster."}, "type": "string"}, "networkPolicy": {"allowedValues": ["none", "azure", "calico"], "defaultValue": "none", "metadata": {"description": "The network policy enforcement to use (none|azure|calico)"}, "type": "string"}, "servicePrincipalClientId": {"metadata": {"description": "Client ID (used by cloudprovider)"}, "type": "securestring"}, "servicePrincipalClientSecret": {"metadata": {"description": "The Service Principal Client Secret."}, "type": "securestring"}, "sshRSAPublicKey": {"metadata": {"description": "SSH public key used for auth to all Linux machines.  Not Required.  If not set, you must provide a password key."}, "type": "string"}, "targetEnvironment": {"defaultValue": "AzurePublicCloud", "metadata": {"description": "The azure deploy environment. Currently support: AzurePublicCloud, AzureChinaCloud"}, "type": "string"}}, "variables": {"agentpool1AccountName": "[concat(variables('storageAccountBaseName'), 'agnt0')]", "agentpool1AvailabilitySet": "[concat('agentpool1-availabilitySet-', variables('nameSuffix'))]", "agentpool1Count": "[parameters('agentpool1Count')]", "agentpool1Index": 0, "agentpool1Offset": "[parameters('agentpool1Offset')]", "agentpool1StorageAccountOffset": "[mul(variables('maxStorageAccountsPerAgent'),variables('agentpool1Index'))]", "agentpool1StorageAccountsCount": "[add(div(variables('agentpool1Count'), variables('maxVMsPerStorageAccount')), mod(add(mod(variables('agentpool1Count'), variables('maxVMsPerStorageAccount')),2), add(mod(variables('agentpool1Count'), variables('maxVMsPerStorageAccount')),1)))]", "agentpool1SubnetName": "[variables('subnetName')]", "agentpool1VMNamePrefix": "[concat(variables('orchestratorName'), '-agentpool1-', variables('nameSuffix'), '-')]", "agentpool1VMSize": "[parameters('agentpool1VMSize')]", "agentpool1VnetSubnetID": "[variables('vnetSubnetID')]", "allocateNodeCidrs": true, "apiServerCertificate": "[parameters('apiServerCertificate')]", "apiServerPrivateKey": "[parameters('apiServerPrivateKey')]", "apiVersionDefault": "2016-03-30", "apiVersionStorage": "2015-06-15", "caCertificate": "[parameters('caCertificate')]", "clientCertificate": "[parameters('clientCertificate')]", "clientPrivateKey": "[parameters('clientPrivateKey')]", "dockerEngineDownloadRepo": "[parameters('dockerEngineDownloadRepo')]", "dockerEngineVersion": "1.12.*", "kubeClusterCidr": "[parameters('kubeClusterCidr')]", "kubeConfigCertificate": "[parameters('kubeConfigCertificate')]", "kubeConfigPrivateKey": "[parameters('kubeConfigPrivateKey')]", "kubeDnsServiceIp": "10.0.0.10", "kubeServiceCidr": "10.0.0.0/16", "kubernetesAPIServerIP": "[parameters('firstConsecutiveStaticIP')]", "kubernetesAddonManagerSpec": "[parameters('kubernetesAddonManagerSpec')]", "kubernetesAddonResizerSpec": "[parameters('kubernetesAddonResizerSpec')]", "kubernetesDNSMasqSpec": "[parameters('kubernetesDNSMasqSpec')]", "kubernetesDashboardSpec": "[parameters('kubernetesDashboardSpec')]", "kubernetesExecHealthzSpec": "[parameters('kubernetesExecHealthzSpec')]", "kubernetesHeapsterSpec": "[parameters('kubernetesHeapsterSpec')]", "kubernetesHyperkubeSpec": "[parameters('kubernetesHyperkubeSpec')]", "kubernetesKubeDNSSpec": "[parameters('kubernetesKubeDNSSpec')]", "kubernetesPodInfraContainerSpec": "[parameters('kubernetesPodInfraContainerSpec')]", "location": "[variables('locations')[mod(add(2,length(parameters('location'))),add(1,length(parameters('location'))))]]", "locations": ["[resourceGroup().location]", "[parameters('location')]"], "masterAvailabilitySet": "[concat('master-availabilityset-', variables('nameSuffix'))]", "masterCount": 1, "masterEtcdClientPort": 2379, "masterEtcdClientURLs": ["[concat('http://', variables('masterPrivateIpAddrs')[0], ':', variables('masterEtcdClientPort'))]", "[concat('http://', variables('masterPrivateIpAddrs')[1], ':', variables('masterEtcdClientPort'))]", "[concat('http://', variables('masterPrivateIpAddrs')[2], ':', variables('masterEtcdClientPort'))]", "[concat('http://', variables('masterPrivateIpAddrs')[3], ':', variables('masterEtcdClientPort'))]", "[concat('http://', variables('masterPrivateIpAddrs')[4], ':', variables('masterEtcdClientPort'))]"], "masterEtcdClusterStates": ["[concat(variables('masterVMNames')[0], '=', variables('masterEtcdPeerURLs')[0])]", "[concat(variables('masterVMNames')[0], '=', variables('masterEtcdPeerURLs')[0], ',', variables('masterVMNames')[1], '=', variables('masterEtcdPeerURLs')[1], ',', variables('masterVMNames')[2], '=', variables('masterEtcdPeerURLs')[2])]", "[concat(variables('masterVMNames')[0], '=', variables('masterEtcdPeerURLs')[0], ',', variables('masterVMNames')[1], '=', variables('masterEtcdPeerURLs')[1], ',', variables('masterVMNames')[2], '=', variables('masterEtcdPeerURLs')[2], ',', variables('masterVMNames')[3], '=', variables('masterEtcdPeerURLs')[3], ',', variables('masterVMNames')[4], '=', variables('masterEtcdPeerURLs')[4])]"], "masterEtcdPeerURLs": ["[concat('http://', variables('masterPrivateIpAddrs')[0], ':', variables('masterEtcdServerPort'))]", "[concat('http://', variables('masterPrivateIpAddrs')[1], ':', variables('masterEtcdServerPort'))]", "[concat('http://', variables('masterPrivateIpAddrs')[2], ':', variables('masterEtcdServerPort'))]", "[concat('http://', variables('masterPrivateIpAddrs')[3], ':', variables('masterEtcdServerPort'))]", "[concat('http://', variables('masterPrivateIpAddrs')[4], ':', variables('masterEtcdServerPort'))]"], "masterEtcdServerPort": 2380, "masterFirstAddrComment": "these MasterFirstAddrComment are used to place multiple masters consecutively in the address space", "masterFirstAddrOctet4": "[variables('masterFirstAddrOctets')[3]]", "masterFirstAddrOctets": "[split(parameters('firstConsecutiveStaticIP'),'.')]", "masterFirstAddrPrefix": "[concat(variables('masterFirstAddrOctets')[0],'.',variables('masterFirstAddrOctets')[1],'.',variables('masterFirstAddrOctets')[2],'.')]", "masterFqdnPrefix": "[tolower(parameters('masterEndpointDNSNamePrefix'))]", "masterLbBackendPoolName": "[concat(variables('orchestratorName'), '-master-pool-', variables('nameSuffix'))]", "masterLbID": "[resourceId('Microsoft.Network/loadBalancers',variables('masterLbName'))]", "masterLbIPConfigID": "[concat(variables('masterLbID'),'/frontendIPConfigurations/', variables('masterLbIPConfigName'))]", "masterLbIPConfigName": "[concat(variables('orchestratorName'), '-master-lbFrontEnd-', variables('nameSuffix'))]", "masterLbName": "[concat(variables('orchestratorName'), '-master-lb-', variables('nameSuffix'))]", "masterOffset": "[parameters('masterOffset')]", "masterPrivateIp": "[parameters('firstConsecutiveStaticIP')]", "masterPrivateIpAddrs": ["[concat(variables('masterFirstAddrPrefix'), add(0, int(variables('masterFirstAddrOctet4'))))]", "[concat(variables('masterFirstAddrPrefix'), add(1, int(variables('masterFirstAddrOctet4'))))]", "[concat(variables('masterFirstAddrPrefix'), add(2, int(variables('masterFirstAddrOctet4'))))]", "[concat(variables('masterFirstAddrPrefix'), add(3, int(variables('masterFirstAddrOctet4'))))]", "[concat(variables('masterFirstAddrPrefix'), add(4, int(variables('masterFirstAddrOctet4'))))]"], "masterPublicIPAddressName": "[concat(variables('orchestratorName'), '-master-ip-', variables('masterFqdnPrefix'), '-', variables('nameSuffix'))]", "masterStorageAccountName": "[concat(variables('storageAccountBaseName'), 'mstr0')]", "masterVMNamePrefix": "[concat(variables('orchestratorName'), '-master-', variables('nameSuffix'), '-')]", "masterVMNames": ["[concat(variables('masterVMNamePrefix'), '0')]", "[concat(variables('masterVMNamePrefix'), '1')]", "[concat(variables('masterVMNamePrefix'), '2')]", "[concat(variables('masterVMNamePrefix'), '3')]", "[concat(variables('masterVMNamePrefix'), '4')]"], "masterVMSize": "[parameters('masterVMSize')]", "maxStorageAccountsPerAgent": "[div(variables('maxVMsPerPool'),variables('maxVMsPerStorageAccount'))]", "maxVMsPerPool": 100, "maxVMsPerStorageAccount": 20, "nameSuffix": "[parameters('nameSuffix')]", "networkPolicy": "[parameters('networkPolicy')]", "nsgID": "[resourceId('Microsoft.Network/networkSecurityGroups',variables('nsgName'))]", "nsgName": "[concat(variables('masterVMNamePrefix'), 'nsg')]", "orchestratorName": "k8s", "orchestratorNameVersionTag": "Kubernetes:1.6.2", "osImageOffer": "UbuntuServer", "osImagePublisher": "Canonical", "osImageSKU": "16.04-LTS", "osImageVersion": "16.04.201705080", "primaryAvailablitySetName": "[concat('agentpool1-availabilitySet-',variables('nameSuffix'))]", "provisionScript": "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", "registerSchedulable": "false", "resourceGroup": "[resourceGroup().name]", "routeTableID": "[resourceId('Microsoft.Network/routeTables', variables('routeTableName'))]", "routeTableName": "[concat(variables('masterVMNamePrefix'),'routetable')]", "servicePrincipalClientId": "[parameters('servicePrincipalClientId')]", "servicePrincipalClientSecret": "[parameters('servicePrincipalClientSecret')]", "sshKeyPath": "[concat('/home/',variables('username'),'/.ssh/authorized_keys')]", "sshNatPorts": [22, 2201, 2202, 2203, 2204], "sshPublicKeyData": "[parameters('sshRSAPublicKey')]", "storageAccountBaseName": "[uniqueString(concat(variables('masterFqdnPrefix'),variables('location')))]", "storageAccountPrefixes": ["0", "6", "c", "i", "o", "u", "1", "7", "d", "j", "p", "v", "2", "8", "e", "k", "q", "w", "3", "9", "f", "l", "r", "x", "4", "a", "g", "m", "s", "y", "5", "b", "h", "n", "t", "z"], "storageAccountPrefixesCount": "[length(variables('storageAccountPrefixes'))]", "subnet": "[parameters('masterSubnet')]", "subnetName": "[concat(variables('orchestratorName'), '-subnet')]", "subscriptionId": "[subscription().subscriptionId]", "targetEnvironment": "[parameters('targetEnvironment')]", "tenantId": "[subscription().tenantId]", "username": "[parameters('linuxAdminUsername')]", "virtualNetworkName": "[concat(variables('orchestratorName'), '-vnet-', variables('nameSuffix'))]", "vmSizesMap": {"Standard_A0": {"storageAccountType": "Standard_LRS"}, "Standard_A1": {"storageAccountType": "Standard_LRS"}, "Standard_A10": {"storageAccountType": "Standard_LRS"}, "Standard_A11": {"storageAccountType": "Standard_LRS"}, "Standard_A1_v2": {"storageAccountType": "Standard_LRS"}, "Standard_A2": {"storageAccountType": "Standard_LRS"}, "Standard_A2_v2": {"storageAccountType": "Standard_LRS"}, "Standard_A2m_v2": {"storageAccountType": "Standard_LRS"}, "Standard_A3": {"storageAccountType": "Standard_LRS"}, "Standard_A4": {"storageAccountType": "Standard_LRS"}, "Standard_A4_v2": {"storageAccountType": "Standard_LRS"}, "Standard_A4m_v2": {"storageAccountType": "Standard_LRS"}, "Standard_A5": {"storageAccountType": "Standard_LRS"}, "Standard_A6": {"storageAccountType": "Standard_LRS"}, "Standard_A7": {"storageAccountType": "Standard_LRS"}, "Standard_A8": {"storageAccountType": "Standard_LRS"}, "Standard_A8_v2": {"storageAccountType": "Standard_LRS"}, "Standard_A8m_v2": {"storageAccountType": "Standard_LRS"}, "Standard_A9": {"storageAccountType": "Standard_LRS"}, "Standard_D1": {"storageAccountType": "Standard_LRS"}, "Standard_D11": {"storageAccountType": "Standard_LRS"}, "Standard_D11_v2": {"storageAccountType": "Standard_LRS"}, "Standard_D11_v2_Promo": {"storageAccountType": "Standard_LRS"}, "Standard_D12": {"storageAccountType": "Standard_LRS"}, "Standard_D12_v2": {"storageAccountType": "Standard_LRS"}, "Standard_D12_v2_Promo": {"storageAccountType": "Standard_LRS"}, "Standard_D13": {"storageAccountType": "Standard_LRS"}, "Standard_D13_v2": {"storageAccountType": "Standard_LRS"}, "Standard_D13_v2_Promo": {"storageAccountType": "Standard_LRS"}, "Standard_D14": {"storageAccountType": "Standard_LRS"}, "Standard_D14_v2": {"storageAccountType": "Standard_LRS"}, "Standard_D14_v2_Promo": {"storageAccountType": "Standard_LRS"}, "Standard_D15_v2": {"storageAccountType": "Standard_LRS"}, "Standard_D1_v2": {"storageAccountType": "Standard_LRS"}, "Standard_D2": {"storageAccountType": "Standard_LRS"}, "Standard_D2_v2": {"storageAccountType": "Standard_LRS"}, "Standard_D2_v2_Promo": {"storageAccountType": "Standard_LRS"}, "Standard_D3": {"storageAccountType": "Standard_LRS"}, "Standard_D3_v2": {"storageAccountType": "Standard_LRS"}, "Standard_D3_v2_Promo": {"storageAccountType": "Standard_LRS"}, "Standard_D4": {"storageAccountType": "Standard_LRS"}, "Standard_D4_v2": {"storageAccountType": "Standard_LRS"}, "Standard_D4_v2_Promo": {"storageAccountType": "Standard_LRS"}, "Standard_D5_v2": {"storageAccountType": "Standard_LRS"}, "Standard_D5_v2_Promo": {"storageAccountType": "Standard_LRS"}, "Standard_DS1": {"storageAccountType": "Premium_LRS"}, "Standard_DS11": {"storageAccountType": "Premium_LRS"}, "Standard_DS11_v2": {"storageAccountType": "Premium_LRS"}, "Standard_DS11_v2_Promo": {"storageAccountType": "Premium_LRS"}, "Standard_DS12": {"storageAccountType": "Premium_LRS"}, "Standard_DS12_v2": {"storageAccountType": "Premium_LRS"}, "Standard_DS12_v2_Promo": {"storageAccountType": "Premium_LRS"}, "Standard_DS13": {"storageAccountType": "Premium_LRS"}, "Standard_DS13_v2": {"storageAccountType": "Premium_LRS"}, "Standard_DS13_v2_Promo": {"storageAccountType": "Premium_LRS"}, "Standard_DS14": {"storageAccountType": "Premium_LRS"}, "Standard_DS14_v2": {"storageAccountType": "Premium_LRS"}, "Standard_DS14_v2_Promo": {"storageAccountType": "Premium_LRS"}, "Standard_DS15_v2": {"storageAccountType": "Premium_LRS"}, "Standard_DS1_v2": {"storageAccountType": "Premium_LRS"}, "Standard_DS2": {"storageAccountType": "Premium_LRS"}, "Standard_DS2_v2": {"storageAccountType": "Premium_LRS"}, "Standard_DS2_v2_Promo": {"storageAccountType": "Premium_LRS"}, "Standard_DS3": {"storageAccountType": "Premium_LRS"}, "Standard_DS3_v2": {"storageAccountType": "Premium_LRS"}, "Standard_DS3_v2_Promo": {"storageAccountType": "Premium_LRS"}, "Standard_DS4": {"storageAccountType": "Premium_LRS"}, "Standard_DS4_v2": {"storageAccountType": "Premium_LRS"}, "Standard_DS4_v2_Promo": {"storageAccountType": "Premium_LRS"}, "Standard_DS5_v2": {"storageAccountType": "Premium_LRS"}, "Standard_DS5_v2_Promo": {"storageAccountType": "Premium_LRS"}, "Standard_F1": {"storageAccountType": "Standard_LRS"}, "Standard_F16": {"storageAccountType": "Standard_LRS"}, "Standard_F16s": {"storageAccountType": "Premium_LRS"}, "Standard_F1s": {"storageAccountType": "Premium_LRS"}, "Standard_F2": {"storageAccountType": "Standard_LRS"}, "Standard_F2s": {"storageAccountType": "Premium_LRS"}, "Standard_F4": {"storageAccountType": "Standard_LRS"}, "Standard_F4s": {"storageAccountType": "Premium_LRS"}, "Standard_F8": {"storageAccountType": "Standard_LRS"}, "Standard_F8s": {"storageAccountType": "Premium_LRS"}, "Standard_G1": {"storageAccountType": "Standard_LRS"}, "Standard_G2": {"storageAccountType": "Standard_LRS"}, "Standard_G3": {"storageAccountType": "Standard_LRS"}, "Standard_G4": {"storageAccountType": "Standard_LRS"}, "Standard_G5": {"storageAccountType": "Standard_LRS"}, "Standard_GS1": {"storageAccountType": "Premium_LRS"}, "Standard_GS2": {"storageAccountType": "Premium_LRS"}, "Standard_GS3": {"storageAccountType": "Premium_LRS"}, "Standard_GS4": {"storageAccountType": "Premium_LRS"}, "Standard_GS5": {"storageAccountType": "Premium_LRS"}, "Standard_H16": {"storageAccountType": "Standard_LRS"}, "Standard_H16m": {"storageAccountType": "Standard_LRS"}, "Standard_H16mr": {"storageAccountType": "Standard_LRS"}, "Standard_H16r": {"storageAccountType": "Standard_LRS"}, "Standard_H8": {"storageAccountType": "Standard_LRS"}, "Standard_H8m": {"storageAccountType": "Standard_LRS"}, "Standard_L16s": {"storageAccountType": "Premium_LRS"}, "Standard_L32s": {"storageAccountType": "Premium_LRS"}, "Standard_L4s": {"storageAccountType": "Premium_LRS"}, "Standard_L8s": {"storageAccountType": "Premium_LRS"}, "Standard_M128ms": {"storageAccountType": "Premium_LRS"}, "Standard_M128s": {"storageAccountType": "Premium_LRS"}, "Standard_M64ms": {"storageAccountType": "Premium_LRS"}, "Standard_NC12": {"storageAccountType": "Standard_LRS"}, "Standard_NC24": {"storageAccountType": "Standard_LRS"}, "Standard_NC24r": {"storageAccountType": "Standard_LRS"}, "Standard_NC6": {"storageAccountType": "Standard_LRS"}, "Standard_NV12": {"storageAccountType": "Standard_LRS"}, "Standard_NV24": {"storageAccountType": "Standard_LRS"}, "Standard_NV6": {"storageAccountType": "Standard_LRS"}}, "vmsPerStorageAccount": 20, "vnetCidr": "10.0.0.0/8", "vnetID": "[resourceId('Microsoft.Network/virtualNetworks',variables('virtualNetworkName'))]", "vnetSubnetID": "[concat(variables('vnetID'),'/subnets/',variables('subnetName'))]"}, "resources": [{"apiVersion": "[variables('apiVersionDefault')]", "dependsOn": ["[variables('vnetID')]"], "location": "[variables('location')]", "name": "[concat(variables('agentpool1VMNamePrefix'), 'nic-', 2)]", "properties": {"enableIPForwarding": true, "ipConfigurations": [{"name": "ipconfig1", "properties": {"primary": true, "privateIPAllocationMethod": "Dynamic", "subnet": {"id": "[variables('agentpool1VnetSubnetID')]"}}}]}, "type": "Microsoft.Network/networkInterfaces"}, {"apiVersion": "[variables('apiVersionDefault')]", "dependsOn": ["[variables('vnetID')]"], "location": "[variables('location')]", "name": "[concat(variables('agentpool1VMNamePrefix'), 'nic-', 1)]", "properties": {"enableIPForwarding": true, "ipConfigurations": [{"name": "ipconfig1", "properties": {"primary": true, "privateIPAllocationMethod": "Dynamic", "subnet": {"id": "[variables('agentpool1VnetSubnetID')]"}}}]}, "type": "Microsoft.Network/networkInterfaces"}, {"apiVersion": "[variables('apiVersionStorage')]", "copy": {"count": "[variables('agentpool1StorageAccountsCount')]", "name": "loop"}, "dependsOn": ["[concat('Microsoft.Network/publicIPAddresses/', variables('masterPublicIPAddressName'))]"], "location": "[variables('location')]", "name": "[concat(variables('storageAccountPrefixes')[mod(add(copyIndex(),variables('agentpool1StorageAccountOffset')),variables('storageAccountPrefixesCount'))],variables('storageAccountPrefixes')[div(add(copyIndex(),variables('agentpool1StorageAccountOffset')),variables('storageAccountPrefixesCount'))],variables('agentpool1AccountName'))]", "properties": {"accountType": "[variables('vmSizesMap')[variables('agentpool1VMSize')].storageAccountType]"}, "type": "Microsoft.Storage/storageAccounts"}, {"apiVersion": "[variables('apiVersionDefault')]", "location": "[variables('location')]", "name": "[variables('agentpool1AvailabilitySet')]", "properties": {}, "type": "Microsoft.Compute/availabilitySets"}, {"apiVersion": "[variables('apiVersionDefault')]", "copy": {"count": "[sub(variables('agentpool1Count'), variables('agentpool1Offset'))]", "name": "vmLoopNode"}, "dependsOn": ["[concat('Microsoft.Storage/storageAccounts/',variables('storageAccountPrefixes')[mod(add(div(copyIndex(variables('agentpool1Offset')),variables('maxVMsPerStorageAccount')),variables('agentpool1StorageAccountOffset')),variables('storageAccountPrefixesCount'))],variables('storageAccountPrefixes')[div(add(div(copyIndex(variables('agentpool1Offset')),variables('maxVMsPerStorageAccount')),variables('agentpool1StorageAccountOffset')),variables('storageAccountPrefixesCount'))],variables('agentpool1AccountName'))]", "[concat('Microsoft.Network/networkInterfaces/', variables('agentpool1VMNamePrefix'), 'nic-', copyIndex(variables('agentpool1Offset')))]", "[concat('Microsoft.Compute/availabilitySets/', variables('agentpool1AvailabilitySet'))]"], "location": "[variables('location')]", "name": "[concat(variables('agentpool1VMNamePrefix'), copyIndex(variables('agentpool1Offset')))]", "properties": {"availabilitySet": {"id": "[resourceId('Microsoft.Compute/availabilitySets',variables('agentpool1AvailabilitySet'))]"}, "hardwareProfile": {"vmSize": "[variables('agentpool1VMSize')]"}, "networkProfile": {"networkInterfaces": [{"id": "[resourceId('Microsoft.Network/networkInterfaces',concat(variables('agentpool1VMNamePrefix'), 'nic-', copyIndex(variables('agentpool1Offset'))))]"}]}, "osProfile": {"adminUsername": "[variables('username')]", "computername": "[concat(variables('agentpool1VMNamePrefix'), copyIndex(variables('agentpool1Offset')))]", "customData": "[base64(concat('#cloud-config\n\nwrite_files:\n- path: \"/etc/systemd/system/docker.service.d/clear_mount_propagation_flags.conf\"\n  permissions: \"0644\"\n  owner: \"root\"\n  content: |\n    [Service]\n    MountFlags=shared\n\n- path: \"/etc/systemd/system/docker.service.d/exec_start.conf\"\n  permissions: \"0644\"\n  owner: \"root\"\n  content: |\n    [Service]\n    ExecStart=\n    ExecStart=/usr/bin/docker daemon -H fd:// --storage-driver=overlay --log-driver=journald\n\n- path: \"/etc/systemd/journald.conf.d/kubernetes.conf\"\n  permissions: \"0644\"\n  owner: \"root\"\n  content: |\n    [Journal]\n    Storage=persistent\n    ForwardToSyslog=no\n    MaxLevelConsole=warning\n    RateLimitInterval=1s\n    RateLimitBurst=20000\n\n- path: \"/etc/docker/daemon.json\"\n  permissions: \"0644\"\n  owner: \"root\"\n  content: |\n    {\n      \"live-restore\": true\n    }\n\n- path: \"/etc/kubernetes/certs/ca.crt\"\n  permissions: \"0644\"\n  encoding: \"base64\"\n  owner: \"root\"\n  content: |\n    ',variables('caCertificate'),'\n\n- path: \"/etc/kubernetes/certs/apiserver.crt\"\n  permissions: \"0644\"\n  encoding: \"base64\"\n  owner: \"root\"\n  content: |\n    ',variables('apiserverCertificate'),'\n\n- path: \"/etc/kubernetes/certs/client.crt\"\n  permissions: \"0644\"\n  encoding: \"base64\"\n  owner: \"root\"\n  content: |\n    ',variables('clientCertificate'),'\n\n- path: \"/var/lib/kubelet/kubeconfig\"\n  permissions: \"0644\"\n  owner: \"root\"\n  content: |\n    apiVersion: v1\n    kind: Config\n    clusters:\n    - name: localcluster\n      cluster:\n        certificate-authority: /etc/kubernetes/certs/ca.crt\n        server: https://',variables('kubernetesAPIServerIP'),':443\n    users:\n    - name: client\n      user:\n        client-certificate: /etc/kubernetes/certs/client.crt\n        client-key: /etc/kubernetes/certs/client.key\n    contexts:\n    - context:\n        cluster: localcluster\n        user: client\n      name: localclustercontext\n    current-context: localclustercontext\n\n- path: \"/etc/systemd/system/kubectl-extract.service\"\n  permissions: \"0644\"\n  owner: \"root\"\n  content: |\n    [Unit]\n    Description=Kubectl extraction\n    Requires=docker.service\n    After=docker.service\n    ConditionPathExists=!/usr/local/bin/kubectl\n\n    [Service]\n    TimeoutStartSec=0\n    Restart=on-failure\n    RestartSec=5s\n    ExecStartPre=/bin/mkdir -p /tmp/kubectldir\n    ExecStartPre=/usr/bin/docker pull ',variables('kubernetesHyperkubeSpec'),'\n    ExecStartPre=/usr/bin/docker run --rm -v /tmp/kubectldir:/opt/kubectldir ',variables('kubernetesHyperkubeSpec'),' /bin/bash -c \"cp /hyperkube /opt/kubectldir/\"\n    ExecStartPre=/bin/mv /tmp/kubectldir/hyperkube /usr/local/bin/kubectl\n    ExecStart=/bin/chmod a+x /usr/local/bin/kubectl\n\n    [Install]\n    WantedBy=multi-user.target\n\n- path: \"/etc/default/kubelet\"\n  permissions: \"0644\"\n  owner: \"root\"\n  content: |\n    KUBELET_CLUSTER_DNS=',variables('kubeDnsServiceIP'),'\n    KUBELET_API_SERVERS=https://',variables('kubernetesAPIServerIP'),':443\n    KUBELET_IMAGE=',variables('kubernetesHyperkubeSpec'),'\n    KUBELET_NETWORK_PLUGIN=kubenet\n    DOCKER_OPTS=\n    CUSTOM_CMD=/bin/true\n    KUBELET_REGISTER_SCHEDULABLE=true\n    KUBELET_NODE_LABELS=role=agent\n    KUBELET_POD_INFRA_CONTAINER_IMAGE=',variables('kubernetesPodInfraContainerSpec'),'\n\n- path: \"/etc/systemd/system/kubelet.service\"\n  permissions: \"0644\"\n  encoding: gzip\n  owner: \"root\"\n  content: !!binary |\n    H4sIAAAAAAAA/5RU32/iOBB+z19hoT7cPZjs/Xhi5Qdasj1UDioC2oe2Qk48JD4cOze2w3K3/d9PCaElgZ60Qorsb+b7xvN58NNaS/cSTMCmKEsnjWYPPgEFLljC314iWCZMugMcWsBKphCMtw6wDwZP8XH1EizBOo6OcbXnBxtEupJodAHafZEKWAguDQVsuVcu3LW1Yp+mYG30TbrYcect++X334LoG6RxrfWIwMJE6jDhNiehKV3I//EIYWq041ID2pPU0OZXeMVOSCS0JGHFMVQyeav8QQ2akoHckidy81NhvHbkO8kQSvI86Cs8D8h3sk8JVT8TqoB8Ii/kM3E5aHIs3dApTaQWF+Uvgc9kKwfXOmhlCr4DanOOcKnWpdHQ1kRIHE8UWEId0byWUNJeT5Xl/6ey0FtsTnO8fYJek+eAEEo1OJYb69ptKUVni7KSCjIQLYBFu6iM8gWwUEA1qj892B7sqPmg6UXq1tHr0dsC91cyanOOZw1HPeBjQuvmGaNFRq3vV2gmG70tLoTria8lUIMDG456wGVzFqsuoQvUhJvJ4u4hWm4Wj6u4YRNy8+/D+jaaRavN9M/xffTawoSE+aEErPnkNGanUF21xlKjtzK79OA91qHg8W2gH4RLI6jUW+T07Q9KZcEzYIP3Qz4uJpvp/MtyvLlbzFfj6TxatgcfdMS4EAjWsk/D5teNKWX2Z+PFHHroZICuR5rW7xTgtYiAxGeZ1BnNuRYK0F60UnAtt2AdLbnLL67zFO3yUuWtA6RCW/be891sHa+i5WYyj1+vp5uCS83a7VCZlKue85lsMm2ag/Cq7uGswDK6nzYV4rs/osl6Nr6dRd1K2gigiieg7PltzBeTaDMb30azuOd/qowXtERTSQHImof3SsJpgnruNOnDv6zR3Yur4bPpOLaFhx+UybnEUmpaGAGsRFNIm3rjLU1Qiqx7TA1ub3BHS+Uzqc88m0err4vlw+Zxtr6fzrtuVezXIHiaauu4Ui/BV64diNsDK7xyknoLOHQcM3DBfwEAAP//30+TnUoHAAA=\n\n- path: \"/opt/azure/containers/kubelet.sh\"\n  permissions: \"0755\"\n  owner: \"root\"\n  content: |\n    #!/bin/bash\n    exit 0\n\n- path: \"/opt/azure/containers/provision.sh\"\n  permissions: \"0744\"\n  encoding: gzip\n  owner: \"root\"\n  content: !!binary |\n    ',variables('provisionScript'),'\n\nruncmd:\n- apt-get update\n- apt-get install -y apt-transport-https ca-certificates nfs-common\n- systemctl enable rpcbind\n- systemctl enable rpc-statd\n- systemctl start rpcbind\n- systemctl start rpc-statd\n- for i in 1 2 3 4 5; do curl --max-time 60 -fsSL https://aptdocker.azureedge.net/gpg | apt-key add -; [ $? -eq 0 ] && break || sleep 5; done\n- echo \"deb ',variables('dockerEngineDownloadRepo'),' ubuntu-xenial main\" | sudo tee /etc/apt/sources.list.d/docker.list\n- \"echo \\\"Package: docker-engine\\nPin: version ',variables('dockerEngineVersion'),'\\nPin-Priority: 550\\n\\\" > /etc/apt/preferences.d/docker.pref\"\n- apt-get update\n- apt-get install -y ebtables\n- apt-get install -y docker-engine\n- systemctl restart docker\n- mkdir -p /etc/kubernetes/manifests\n- usermod -aG docker ',variables('username'),'\n\n'))]", "linuxConfiguration": {"disablePasswordAuthentication": "true", "ssh": {"publicKeys": [{"keyData": "[parameters('sshRSAPublicKey')]", "path": "[variables('sshKeyPath')]"}]}}}, "storageProfile": {"imageReference": {"offer": "[variables('osImageOffer')]", "publisher": "[variables('osImagePublisher')]", "sku": "[variables('osImageSKU')]", "version": "[variables('osImageVersion')]"}, "osDisk": {"caching": "ReadWrite", "createOption": "FromImage", "name": "[concat(variables('agentpool1VMNamePrefix'), copyIndex(variables('agentpool1Offset')),'-osdisk')]", "vhd": {"uri": "[concat(reference(concat('Microsoft.Storage/storageAccounts/',variables('storageAccountPrefixes')[mod(add(div(copyIndex(variables('agentpool1Offset')),variables('maxVMsPerStorageAccount')),variables('agentpool1StorageAccountOffset')),variables('storageAccountPrefixesCount'))],variables('storageAccountPrefixes')[div(add(div(copyIndex(variables('agentpool1Offset')),variables('maxVMsPerStorageAccount')),variables('agentpool1StorageAccountOffset')),variables('storageAccountPrefixesCount'))],variables('agentpool1AccountName')),variables('apiVersionStorage')).primaryEndpoints.blob,'osdisk/', variables('agentpool1VMNamePrefix'), copyIndex(variables('agentpool1Offset')), '-osdisk.vhd')]"}}}}, "tags": {"creationSource": "[concat('acsengine-', variables('agentpool1VMNamePrefix'), copyIndex(variables('agentpool1Offset')))]", "orchestrator": "[variables('orchestratorNameVersionTag')]", "resourceNameSuffix": "[variables('nameSuffix')]"}, "type": "Microsoft.Compute/virtualMachines"}, {"apiVersion": "[variables('apiVersionDefault')]", "copy": {"count": "[sub(variables('agentpool1Count'), variables('agentpool1Offset'))]", "name": "vmLoopNode"}, "dependsOn": ["[concat('Microsoft.Compute/virtualMachines/', variables('agentpool1VMNamePrefix'), copyIndex(variables('agentpool1Offset')))]"], "location": "[variables('location')]", "name": "[concat(variables('agentpool1VMNamePrefix'), copyIndex(variables('agentpool1Offset')),'/cse', copyIndex(variables('agentpool1Offset')))]", "properties": {"autoUpgradeMinorVersion": true, "protectedSettings": {"commandToExecute": "[concat('/usr/bin/nohup /bin/bash -c \"/bin/bash /opt/azure/containers/provision.sh ',variables('tenantID'),' ',variables('subscriptionId'),' ',variables('resourceGroup'),' ',variables('location'),' ',variables('subnetName'),' ',variables('nsgName'),' ',variables('virtualNetworkName'),' ',variables('routeTableName'),' ',variables('primaryAvailablitySetName'),' ',variables('servicePrincipalClientId'),' ',variables('servicePrincipalClientSecret'),' ',variables('clientPrivateKey'),' ',variables('targetEnvironment'),' ',variables('networkPolicy'),' >> /var/log/azure/cluster-provision.log 2>&1 &\" &')]"}, "publisher": "Microsoft.Azure.Extensions", "settings": {}, "type": "CustomScript", "typeHandlerVersion": "2.0"}, "type": "Microsoft.Compute/virtualMachines/extensions"}, {"apiVersion": "[variables('apiVersionDefault')]", "location": "[variables('location')]", "name": "[variables('masterAvailabilitySet')]", "properties": {}, "type": "Microsoft.Compute/availabilitySets"}, {"apiVersion": "[variables('apiVersionStorage')]", "dependsOn": ["[concat('Microsoft.Network/publicIPAddresses/', variables('masterPublicIPAddressName'))]"], "location": "[variables('location')]", "name": "[variables('masterStorageAccountName')]", "properties": {"accountType": "[variables('vmSizesMap')[variables('masterVMSize')].storageAccountType]"}, "type": "Microsoft.Storage/storageAccounts"}, {"apiVersion": "[variables('apiVersionDefault')]", "dependsOn": ["[concat('Microsoft.Network/networkSecurityGroups/', variables('nsgName'))]", "[concat('Microsoft.Network/routeTables/', variables('routeTableName'))]"], "location": "[variables('location')]", "name": "[variables('virtualNetworkName')]", "properties": {"addressSpace": {"addressPrefixes": ["[variables('vnetCidr')]"]}, "subnets": [{"name": "[variables('subnetName')]", "properties": {"addressPrefix": "[variables('subnet')]", "networkSecurityGroup": {"id": "[variables('nsgID')]"}, "routeTable": {"id": "[variables('routeTableID')]"}}}]}, "type": "Microsoft.Network/virtualNetworks"}, {"apiVersion": "[variables('apiVersionDefault')]", "location": "[variables('location')]", "name": "[variables('nsgName')]", "properties": {"securityRules": [{"name": "allow_ssh", "properties": {"access": "Allow", "description": "Allow SSH traffic to master", "destinationAddressPrefix": "*", "destinationPortRange": "22-22", "direction": "Inbound", "priority": 101, "protocol": "Tcp", "sourceAddressPrefix": "*", "sourcePortRange": "*"}}, {"name": "allow_kube_tls", "properties": {"access": "Allow", "description": "Allow kube-apiserver (tls) traffic to master", "destinationAddressPrefix": "*", "destinationPortRange": "443-443", "direction": "Inbound", "priority": 100, "protocol": "Tcp", "sourceAddressPrefix": "*", "sourcePortRange": "*"}}]}, "type": "Microsoft.Network/networkSecurityGroups"}, {"apiVersion": "[variables('apiVersionDefault')]", "location": "[variables('location')]", "name": "[variables('routeTableName')]", "type": "Microsoft.Network/routeTables"}, {"apiVersion": "[variables('apiVersionDefault')]", "dependsOn": ["[concat('Microsoft.Network/publicIPAddresses/', variables('masterPublicIPAddressName'))]"], "location": "[variables('location')]", "name": "[variables('masterLbName')]", "properties": {"backendAddressPools": [{"name": "[variables('masterLbBackendPoolName')]"}], "frontendIPConfigurations": [{"name": "[variables('masterLbIPConfigName')]", "properties": {"publicIPAddress": {"id": "[resourceId('Microsoft.Network/publicIPAddresses',variables('masterPublicIPAddressName'))]"}}}], "loadBalancingRules": [{"name": "LBRuleHTTPS", "properties": {"backendAddressPool": {"id": "[concat(variables('masterLbID'), '/backendAddressPools/', variables('masterLbBackendPoolName'))]"}, "backendPort": 443, "enableFloatingIP": false, "frontendIPConfiguration": {"id": "[variables('masterLbIPConfigID')]"}, "frontendPort": 443, "idleTimeoutInMinutes": 5, "loadDistribution": "Default", "probe": {"id": "[concat(variables('masterLbID'),'/probes/tcpHTTPSProbe')]"}, "protocol": "tcp"}}], "probes": [{"name": "tcpHTTPSProbe", "properties": {"intervalInSeconds": "5", "numberOfProbes": "2", "port": 443, "protocol": "tcp"}}]}, "type": "Microsoft.Network/loadBalancers"}, {"apiVersion": "[variables('apiVersionDefault')]", "location": "[variables('location')]", "name": "[variables('masterPublicIPAddressName')]", "properties": {"dnsSettings": {"domainNameLabel": "[variables('masterFqdnPrefix')]"}, "publicIPAllocationMethod": "Dynamic"}, "type": "Microsoft.Network/publicIPAddresses"}, {"apiVersion": "[variables('apiVersionDefault')]", "copy": {"count": "[sub(variables('masterCount'), variables('masterOffset'))]", "name": "masterLbLoopNode"}, "dependsOn": ["[variables('masterLbID')]"], "location": "[variables('location')]", "name": "[concat(variables('masterLbName'), '/', 'SSH-', variables('masterVMNamePrefix'), copyIndex(variables('masterOffset')))]", "properties": {"backendPort": 22, "enableFloatingIP": false, "frontendIPConfiguration": {"id": "[variables('masterLbIPConfigID')]"}, "frontendPort": "[variables('sshNatPorts')[copyIndex(variables('masterOffset'))]]", "protocol": "tcp"}, "type": "Microsoft.Network/loadBalancers/inboundNatRules"}, {"apiVersion": "[variables('apiVersionDefault')]", "copy": {"count": "[sub(variables('masterCount'), variables('masterOffset'))]", "name": "nicLoopNode"}, "dependsOn": ["[variables('vnetID')]", "[concat(variables('masterLbID'),'/inboundNatRules/SSH-',variables('masterVMNamePrefix'),copyIndex(variables('masterOffset')))]"], "location": "[variables('location')]", "name": "[concat(variables('masterVMNamePrefix'), 'nic-', copyIndex(variables('masterOffset')))]", "properties": {"enableIPForwarding": true, "ipConfigurations": [{"name": "ipconfig1", "properties": {"loadBalancerBackendAddressPools": [{"id": "[concat(variables('masterLbID'), '/backendAddressPools/', variables('masterLbBackendPoolName'))]"}], "loadBalancerInboundNatRules": [{"id": "[concat(variables('masterLbID'),'/inboundNatRules/SSH-',variables('masterVMNamePrefix'),copyIndex(variables('masterOffset')))]"}], "primary": true, "privateIPAddress": "[variables('masterPrivateIpAddrs')[copyIndex(variables('masterOffset'))]]", "privateIPAllocationMethod": "Static", "subnet": {"id": "[variables('vnetSubnetID')]"}}}]}, "type": "Microsoft.Network/networkInterfaces"}, {"apiVersion": "[variables('apiVersionDefault')]", "copy": {"count": "[sub(variables('masterCount'), variables('masterOffset'))]", "name": "vmLoopNode"}, "dependsOn": ["[concat('Microsoft.Network/networkInterfaces/', variables('masterVMNamePrefix'), 'nic-', copyIndex(variables('masterOffset')))]", "[concat('Microsoft.Compute/availabilitySets/',variables('masterAvailabilitySet'))]", "[variables('masterStorageAccountName')]"], "location": "[variables('location')]", "name": "[concat(variables('masterVMNamePrefix'), copyIndex(variables('masterOffset')))]", "properties": {"availabilitySet": {"id": "[resourceId('Microsoft.Compute/availabilitySets',variables('masterAvailabilitySet'))]"}, "hardwareProfile": {"vmSize": "[variables('masterVMSize')]"}, "networkProfile": {"networkInterfaces": [{"id": "[resourceId('Microsoft.Network/networkInterfaces',concat(variables('masterVMNamePrefix'),'nic-', copyIndex(variables('masterOffset'))))]"}]}, "osProfile": {"adminUsername": "[variables('username')]", "computername": "[concat(variables('masterVMNamePrefix'), copyIndex(variables('masterOffset')))]", "customData": "[base64(concat('#cloud-config\n\npackages:\n - etcd\n - jq\n - traceroute\n\n\ndisk_setup:\n  /dev/sdc:\n      table_type: gpt\n      layout: true\n      overwrite: false\n\nfs_setup:\n- label: etcd_disk\n  filesystem: ext4\n  device: /dev/sdc1\n  extra_opts:\n    - \"-F\"\n    - \"-E\"\n    - \"lazy_itable_init=1,lazy_journal_init=1\"\n\n\nmounts:\n- - /dev/sdc1\n  - /var/lib/etcddisk\n\nwrite_files:\n- path: \"/etc/systemd/system/docker.service.d/clear_mount_propagation_flags.conf\"\n  permissions: \"0644\"\n  owner: \"root\"\n  content: |\n    [Service]\n    MountFlags=shared\n\n- path: \"/etc/systemd/system/docker.service.d/exec_start.conf\"\n  permissions: \"0644\"\n  owner: \"root\"\n  content: |\n    [Service]\n    ExecStart=\n    ExecStart=/usr/bin/docker daemon -H fd:// --storage-driver=overlay --log-driver=journald\n\n- path: \"/etc/systemd/journald.conf.d/kubernetes.conf\"\n  permissions: \"0644\"\n  owner: \"root\"\n  content: |\n    [Journal]\n    Storage=persistent\n    ForwardToSyslog=no\n    MaxLevelConsole=warning\n    RateLimitInterval=1s\n    RateLimitBurst=20000\n  \n- path: \"/etc/docker/daemon.json\"\n  permissions: \"0644\"\n  owner: \"root\"\n  content: |\n    {\n      \"live-restore\": true\n    }\n\n- path: \"/etc/kubernetes/certs/ca.crt\"\n  permissions: \"0644\"\n  encoding: \"base64\"\n  owner: \"root\"\n  content: |\n    ',variables('caCertificate'),'\n\n- path: \"/etc/kubernetes/certs/apiserver.crt\"\n  permissions: \"0644\"\n  encoding: \"base64\"\n  owner: \"root\"\n  content: |\n    ',variables('apiServerCertificate'),'\n\n- path: \"/etc/kubernetes/certs/client.crt\"\n  permissions: \"0644\"\n  encoding: \"base64\"\n  owner: \"root\"\n  content: |\n    ',variables('clientCertificate'),'\n\n- path: \"/var/lib/kubelet/kubeconfig\"\n  permissions: \"0644\"\n  owner: \"root\"\n  content: |\n    apiVersion: v1\n    kind: Config\n    clusters:\n    - name: localcluster\n      cluster:\n        certificate-authority: /etc/kubernetes/certs/ca.crt\n        server: ',concat('https://', variables('masterPrivateIpAddrs')[copyIndex(variables('masterOffset'))], ':443'),'\n    users:\n    - name: client\n      user:\n        client-certificate: /etc/kubernetes/certs/client.crt\n        client-key: /etc/kubernetes/certs/client.key\n    contexts:\n    - context:\n        cluster: localcluster\n        user: client\n      name: localclustercontext\n    current-context: localclustercontext\n\n- path: /etc/kubernetes/manifests/kube-apiserver.yaml\n  permissions: \"0644\"\n  encoding: gzip\n  owner: \"root\"\n  content: !!binary |\n    H4sIAAAAAAAA/6RUX0/bThB8z6ew/JzDwA/phyyMhGilIlGUEqnvm7tNcs39696eUfrpq3OcEOxAKzV58s3O7Hh2fRD0d6SovauLsr0oJxvtVF2UM6/KiUUGBQz1pCgcWKyLcpMWKCDoiNQilT0QA8gDGreR0WbIwAJNzOyiYI1UF9I7Jm9EMOCwO5feBu/QcV281Z7EgDJz1z7yE/KLp01dMKXMyzqgHVKvLt73l3/awiqjNxkmh4zxyzYg5cd5QHm7L5TeWsgB9M9ZuazW+9ry+HjUpTsVApTVMScq+rdtnvYRPeolyq00OH3UVvMzuBXSdI7Uaol3UvrkePoJl5AMz9kTrPDeQIzTZ4w+kcRvyTOM+inCGJvzs+4/RI3xLyKQbrXBFaoBrF1EmQhF8MTN9fn1kH8MX139N0Cl8UmJQL7VCqmBX4nwZIn0bqlXTYUsq9chVB3h7Ef0btS2y0RIkyIjCR0E5bSaboR9Yvda0e2AiCyV2M0lNmvmUFfVxeX/XTYX9Y2FLPeZpbo3Gh3PPPFJiZ/JU7KCEFSTl24UeovEOuIh/qPdups9zDsHD7OhNpsoJBKLpTY4iiMjsTos1pkkPsHPwwRGscHt38lscDsaSn55IeEjAQknDOwHA7tt/RcTcbfhYgFyg041OffLQU3bXO1PWm+Sxa+5a//Vv/nykaV4bf8qUxQ2U2bA67ooBy7LsU4LJIxedFoG+V2hFqgyelEd1e0cDq+k08byrdZJHfTDBw7/5O59tZHN3wEAAP//zxkJl/IFAAA=\n\n- path: /etc/kubernetes/manifests/kube-controller-manager.yaml\n  permissions: \"0644\"\n  encoding: gzip\n  owner: \"root\"\n  content: !!binary |\n    H4sIAAAAAAAA/4xTwW7bMAy95ysE3xVjOxpxLwWGXVYEGLA7IzGJFknUKNpb9vUDXafZnKarb3x87/GZoKCEb8g1UO5MM35oVqeQfWeaLflmlVDAg0C3MiZDws40p2GH1lEWphiRbYIMB+RmZtQC7oVWz1UwaSvCDmNVG2MkIHdmtrAlQsYJd5QKZczSmTtDVrWgU5MjVXlC+Ul86ozwoAZKh5CR5zH2HYn1CwkOStsojzMK1s/ngqzl14Lu4UJ0lBLobuZaRzTt8cJt/obvj5va1qrCUd6HQ9+OwG0Mu1axiNJeewsRxEgOBG0mj9YFz7XfXMAn8vio0MNC5eJQBXni99NfPj4jyr5H1t31mwRafPrh85ZxH37dsmnwtjCNwSP38HtgfJVy+VUU11733E6C9fdKeaFiIrEO7D5EvFE5ZKmtg7VjWegq8hgcWnCOhiy2cBh1YSc8v+UFJagSeX3C88IyInhkixGd9Hpri/7Yf7wgI8Uh4RedXP85k/kSUZy9zr76GJNUswU5dqZZRGxufUZgG8POzgdz12hxWMp7jrh8Iq8H01c2Wb34lzcS/i/dfbebmH8CAAD//xTSHoaUBAAA\n\n- path: /etc/kubernetes/manifests/kube-scheduler.yaml\n  permissions: \"0644\"\n  encoding: gzip\n  owner: \"root\"\n  content: !!binary |\n    H4sIAAAAAAAA/4SRzU7DMBCE73mKle9WBEeLcuYCqoTEfeMsjVX/yd4E9e3RtmlTQgu+eWfmy2yM2X1QqS5FA2p6UM3exd6A2qZeNYEYe2Q0DUDEQAbUfuxIVztQP3oqahZqRruoh8oURPLYka+SBmBHxYBNkUvyOnuMdJzbFHKKFNnAT3ZTM1nJDqnyG/FXKnsDXEbJCQddpDLT9f1+clzAnahPIpdITPXlkKnI9T2TfT4bbQoBY2/mq4BVO5yt6nr86yPHqdZitCl+ut2mnbC03nWtzDxxu2irkCfsqWjyZHkjO670afN4nkzJj4Fe0xi5XvecfwCx1cuWCwYgSGSLPBhQLbFtb9kunAmL9q7Tc/W7oNWK4js1XL/M7WLyuEfUhZ//aPhfu/u0GzVPp/kOAAD///HHGWACAwAA\n\n- path: /etc/kubernetes/manifests/kube-addon-manager.yaml\n  permissions: \"0644\"\n  encoding: gzip\n  owner: \"root\"\n  content: !!binary |\n    H4sIAAAAAAAA/3yQzU7DMAzH730Ka/eqcNglQkg8QGESEneTWFvUJQ6xU9S3R+kX22XH2L//h4PJf1EWz9HA+NwMPjoDJ3ZNIEWHiqYBiBjIwFC+qUXnOLYBI54prytJaLe9TKIUGoDxxlUS2epzYdF30l/OgwHNhRoAy1HRR8pSifZRFoAPeCYDL3WdIynJW2X6BflMZF9nLpNwyZZmz2XwU0h0fwPYVAwcw/4OFDhPBo5PvZ+HI19LoJ5L3GRbubmXrMpQgRPqxcChI7Xdf7duAQ97B3Qf8Trtpy8Jd3ffWNfPmn1XeXqY8RcAAP//D9wkjsgBAAA=\n\n- path: /etc/kubernetes/addons/kube-dns-service.yaml\n  permissions: \"0644\"\n  encoding: gzip\n  owner: \"root\"\n  content: !!binary |\n    H4sIAAAAAAAA/3xQwUoDMRC95yuG3lO7iCBztRcRpFD1ns2+Q9hsEjKTgn8vcbugoCWXvDfvvXmMK+EDVUJOTJfBzCFNTGfUS/AwC9RNTh0bouhGROk/ovlRrCuFaW4j7JRkZduImqCQfch3PjZRVCtrFtNOa8PuD2VyC5he2ojj69kQrfhHdCekOL+x8imKxUiB732um55PTMNh399wMEQlV/3ua6+JW88+YHq4X0HNmn2OTO/H02+xVV9uGd6eukEQ4TXX/y7zFQAA//8ZlC5KYQEAAA==\n\n- path: /etc/kubernetes/addons/kube-dns-deployment.yaml\n  permissions: \"0644\"\n  encoding: gzip\n  owner: \"root\"\n  content: !!binary |\n    H4sIAAAAAAAA/8xW32/bNhB+919x0F4nRW6RNSPmAkNSrMDQzpizvcx7oMlLRIQiGd7RiDvsfx8kOxatOplTDEP5ZNzPz/fdfZAM5neMZLwTsJ5O7ozTAn7FYI2SbLy79I6jtxbjpEWWWrIUEwArV2ip+wVwl1YYHTJSZfyZsokYY0kY10ahgIJjwmIbeUGlDEH0KaV21FvXQ//vJwBOtjhElIORglSPHtoQYzuhgKoDEbeAScCrCQChRcU+itObMrbBSsZtSv5Puyed89yPgx5NAKQa1MlirKQNjaxGY4iGjZK2DF4LKIoT09hbjLtOUPzx17K4w82yEMviclfwR629o1+c3SyLb5eFD128j33MuwdDTMvi7z8f++U8PT2Ml7F4ZHwAj0x0T3nH0jiM+8YlyHibwSihKEvtW2ncbNeqsl5JWxWjGEdl8JFn07o+fz04TStvUcAPA+qf0wqvPi4WAdXbfZg1a3RINI9+hUN7gBtpbIp43USkxlst4DzzNszhJ+Q8ASBIbgQUZw1Ky82nsmutHRWHQT6ygIv6oj4wd6R3W/3++nqeOYwzbKS9Qis3C1TeaRLwXZ5KSSkkynBOMy+bFn3iferwH4Yjyjnu0B2wsGdq3uPuh5zV31bpOOjJyTwhevbKWwG/Xc2/pCCr8EzR68uhaESpzVESn6Vpn/YEQdMvJuh1fRIFEcmnqJByfNa0hukQcYutjxsB0zf1B5N5It4npHG0Cqmfa3u0Rlbi6M0pqRosyXzC7qLq0bU5X3ao7Xpk71QA42z66k1VV3U1/WZ0jX2Q9bfljVTGGt7MyudO9erj4oOk+8NT3a9GK+n+5I09vl0vX9Snt/Rf9vP4lFs9c2S9v0shF1aNNzJZrmitqgPZg/1o4e2ZxvWZS9aO5puine3FZzen4j/rK3pKT+z+mfT1Ib1Od9I3st8ng/zcPrx7QPV+W/r/k+/PJghfnXzvoJ58DCPcT8npC2Xp/AWqdFyUsgra0dxbozYCrrZLuXM4r3Fx8N3WvRXy+AvJkwBrXHr4JwAA//+O/Dp4ugoAAA==\n\n- path: /etc/kubernetes/addons/kube-proxy-daemonset.yaml\n  permissions: \"0644\"\n  encoding: gzip\n  owner: \"root\"\n  content: !!binary |\n    H4sIAAAAAAAA/5RUu47bMBDs/RWEeh3vWuEujVOkyQMwkJ6m5mzCfCi7S8f++4BSbFH3cC6qhNnh7OysRDO4nyB2KXYKJ0Esr6yPD1uIeVgdXOw79dkgpLiBrALE9EZMt1LKmy08lzelDnkLihDwnUva+swCahl0dBadaoQympFpUxhSRJRuPNQOlE7nsSIO1KmYeqyUiibgBaNAPBh7wfnMgrDiAbaYEITBG8FkqDZantrsbRuvrCh1aTEdjGJcBF3F2iIWTOxn9VY1en8eQEW7qeBlm1Y1bVsoNsVnt3vSR0Pau60umIfoudYsD10Stq6np8dCW0/I2vX0aSa7YHYl/8d5QV8uvjYDbEV9I/HpIXDKZFGlV8BfGSwLTCk75E493N+HK8qwmZyc1ykKTlLTB3JH57FD36nyfVxLx+RzwNeUY63fqlCQH0b2nWo0xGpmry1IuKlkpzmYfTuW2n1iWRg3/ffozy96vqE+R/ZaHmLbuf7f8h/Zc72RqfavNmXSb5DfiQ4LfMqz+l4LcbRSb+OvtcykeW8I2poxQffsrFmEcCPh29ofGfudoW8Lv7euG8sqP/cGHlYSzZLl1rtbXmaJO+VdzKc/AQAA//9Q4RzJKwUAAA==\n\n- path: /etc/kubernetes/addons/kubernetes-dashboard-deployment.yaml\n  permissions: \"0644\"\n  encoding: gzip\n  owner: \"root\"\n  content: !!binary |\n    H4sIAAAAAAAA/4SST2vbQBDF7/oUg++KY3ppllIoNfTSg8Cl99HqES+Z/cPOyI2+fRFxLAlCPKfhzdPTT6PhEv6iasjJEV4NaW51fzn0MD40LyENjo4okqeIZE2E8cDGriES7iE6d0QvY4+aYNCHkPdeRjXUVlEvwcPRzuqI3Zvzq7Zcils90g6s5z5zHRqixBGfDrWwvzpandQQGy3wM0dFkeBZHR0aIoXAW65vhJHNn3+vkO+jGGIRNlwDVp8+l2yy7qcRvWPO5XMyDgn1ltAS12d1dAsMkZ/h6NuSd3yPOxX471tjN4p0WYKfHP2QfzzpbS7hggTVruYeCzDR2az8gq0losJ2drTb77Zqrubo6fHpcSWHFCywHCE8neBzGtTRl7XDQkQe7aPhpz96eelqw+2yte4jnFKzZZ/F0Z+f3VVPecBpcwhzzdf9sL3ZrI4kpPGVmv8BAAD//yF1c5kVAwAA\n\n- path: /etc/kubernetes/addons/kubernetes-dashboard-service.yaml\n  permissions: \"0644\"\n  encoding: gzip\n  owner: \"root\"\n  content: !!binary |\n    H4sIAAAAAAAA/4yOsU4EMQxE+3yFdX3g6O78EQgJid6bjCC63SSyvSfd36NkKagQ3Wg843nSywfUSqtM95dwKzUzvUPvJSFscMniwoFolQWrDUV02xdohcOeSntO624OjXa0mE6uO05H8mJReudflZjFvpYmmgNRlQ1/Hq1L+klEe5hjC9aRBkdv6hMoTsl0Oc9NF/2Ev03rer4O07AieVP+F5Q/OpheW8Z4Er4DAAD//6UyTnEjAQAA\n\n- path: /etc/kubernetes/addons/kube-heapster-service.yaml\n  permissions: \"0644\"\n  encoding: gzip\n  owner: \"root\"\n  content: !!binary |\n    H4sIAAAAAAAA/2yOvWrEMBCEez3F4l75q4yeIGUgkH4tD4mwLIndtSFvf8h2cQfXDcN++w239APRVEug/d0tqcyBviF7inArjGc2Do4o84SsPREt2wQpMOhLqq8xb2oQrycVaDDZMDy5LLwi0Ce4dcARncXfY6GN+5eOev1Xw+q0IXZ1q2LHBn/EQOPboTGWX9jXVY0fjkiREa3KtXhUz63duW4BAAD//6ozJXX5AAAA\n\n- path: /etc/kubernetes/addons/kube-heapster-deployment.yaml\n  permissions: \"0644\"\n  encoding: gzip\n  owner: \"root\"\n  content: !!binary |\n    H4sIAAAAAAAA/6xUXWvbShB9169Y9HxXse9NIHe5uhCSlD40TUigUKpiJqtJtXi/ujsyVkv/e5Es2bJihxCqJ3Nm5pzx2bPLOU+WypaCXaHXrjFoKYkepUgYC+i1khAFmyeMERqvgbCtMDb0tJ90lkBZDHFAOFMGvqFg/y3rRwwWCeN7BB8Jw4NH+X/f184aA7YUW4Cz9KTqW9Mxynl0dZCY7yizWBsDoVmAV6JIi3Q3YMGgYAPRFg64IYk7wRb8XmOkPYwx6WvBzmdmDzRoXGgEm5/ObtSoopVRbyY45NZFWTp7j1H9eJVj3pULC9Y2E8ukr/PzmZmguKYAXW2WnU2Lmw3zbsGDc33D6bMyVQFj5XSZn00q5TZc+XAkfDXP/s5m/BEJsvl07SFR+ZEoeKc19xiUK/N/Zu03XTWSMkAu5Lj2zqIlBfpYPHhn3ZtDcnbkjP99ZUZeNY92NT7yFega3wVn9vmeFOryHp/20R6/A6oEM0hQAkHWejBq21hy83lxd3u1+Hhxc/3n1aIH+aLkw93F5aBrXYkPqFGSCzuBLi6jF0C5ExcF08rW62Rj3kZwGNHwiHrk+vI8cvD+wNuwwhCVs4JtktnjYK0jIOXsiCTKCstaY8hA+2q6kAyKlATNvSsFGz1KL4+R0xh6JZZ++VmkS2yKVBTpZU/YPQrx1uqmSP8qUufbfhe6nuu1ihSL9NfXVi/uGWeAZPVhz4hjNkxNAK8+DRCuCW37M56s5u1BzJOx22OnD9Mfcnhina67CxkxrJREwVIKNbb/aJsf0Y3w2ERCkzy7yj118jsAAP//Os2RQNoGAAA=\n\n- path: /etc/kubernetes/addons/default-storage-class.yaml\n  permissions: \"0644\"\n  encoding: gzip\n  owner: \"root\"\n  content: !!binary |\n    H4sIAAAAAAAA/1zPMU4EMQyF4T6nsLZP0HYoLUdAovdMHshKNlnZzhScHmUZkKB++f7IMcbAd3mDmoyeyXwofyDVZ0syno7rBudrqNJLptfv8aWxWbjBubBzDkSdb8hU8M6zeSDi3oezy+i2ZvrJ7kumlUx1btAOx+MfsXjq+HiT6eI6cQlEjTe0M/MX7W2aQ6NBD9nxa+46DlnnQPM/wp9TEYtYDV8BAAD//2p7hGT6AAAA\n\n- path: \"/etc/systemd/system/kubectl-extract.service\"\n  permissions: \"0644\"\n  owner: \"root\"\n  content: |\n    [Unit]\n    Description=Kubectl extraction\n    Requires=docker.service\n    After=docker.service\n    ConditionPathExists=!/usr/local/bin/kubectl\n\n    [Service]\n    TimeoutStartSec=0\n    Restart=on-failure\n    RestartSec=5s\n    ExecStartPre=/bin/mkdir -p /tmp/kubectldir\n    ExecStartPre=/usr/bin/docker pull ',variables('kubernetesHyperkubeSpec'),'\n    ExecStartPre=/usr/bin/docker run --rm -v /tmp/kubectldir:/opt/kubectldir ',variables('kubernetesHyperkubeSpec'),' /bin/bash -c \"cp /hyperkube /opt/kubectldir/\"\n    ExecStartPre=/bin/mv /tmp/kubectldir/hyperkube /usr/local/bin/kubectl\n    ExecStart=/bin/chmod a+x /usr/local/bin/kubectl\n\n    [Install]\n    WantedBy=multi-user.target\n\n- path: \"/etc/default/kubelet\"\n  permissions: \"0644\"\n  owner: \"root\"\n  content: |\n    KUBELET_CLUSTER_DNS=',variables('kubeDnsServiceIP'),'\n    KUBELET_API_SERVERS=',concat('https://', variables('masterPrivateIpAddrs')[copyIndex(variables('masterOffset'))], ':443'),'\n    KUBELET_IMAGE=',variables('kubernetesHyperkubeSpec'),'\n    KUBELET_NETWORK_PLUGIN=\n    DOCKER_OPTS=\n    KUBELET_REGISTER_SCHEDULABLE=',variables('registerSchedulable'),'\n    KUBELET_NODE_LABELS=role=master\n    KUBELET_POD_INFRA_CONTAINER_IMAGE=',variables('kubernetesPodInfraContainerSpec'),'\n\n- path: \"/etc/systemd/system/kubelet.service\"\n  permissions: \"0644\"\n  encoding: gzip\n  owner: \"root\"\n  content: !!binary |\n    H4sIAAAAAAAA/5RU32/iOBB+z19hoT7cPZjs/Xhi5Qdasj1UDioC2oe2Qk48JD4cOze2w3K3/d9PCaElgZ60Qorsb+b7xvN58NNaS/cSTMCmKEsnjWYPPgEFLljC314iWCZMugMcWsBKphCMtw6wDwZP8XH1EizBOo6OcbXnBxtEupJodAHafZEKWAguDQVsuVcu3LW1Yp+mYG30TbrYcect++X334LoG6RxrfWIwMJE6jDhNiehKV3I//EIYWq041ID2pPU0OZXeMVOSCS0JGHFMVQyeav8QQ2akoHckidy81NhvHbkO8kQSvI86Cs8D8h3sk8JVT8TqoB8Ii/kM3E5aHIs3dApTaQWF+Uvgc9kKwfXOmhlCr4DanOOcKnWpdHQ1kRIHE8UWEId0byWUNJeT5Xl/6ey0FtsTnO8fYJek+eAEEo1OJYb69ptKUVni7KSCjIQLYBFu6iM8gWwUEA1qj892B7sqPmg6UXq1tHr0dsC91cyanOOZw1HPeBjQuvmGaNFRq3vV2gmG70tLoTria8lUIMDG456wGVzFqsuoQvUhJvJ4u4hWm4Wj6u4YRNy8+/D+jaaRavN9M/xffTawoSE+aEErPnkNGanUF21xlKjtzK79OA91qHg8W2gH4RLI6jUW+T07Q9KZcEzYIP3Qz4uJpvp/MtyvLlbzFfj6TxatgcfdMS4EAjWsk/D5teNKWX2Z+PFHHroZICuR5rW7xTgtYiAxGeZ1BnNuRYK0F60UnAtt2AdLbnLL67zFO3yUuWtA6RCW/be891sHa+i5WYyj1+vp5uCS83a7VCZlKue85lsMm2ag/Cq7uGswDK6nzYV4rs/osl6Nr6dRd1K2gigiieg7PltzBeTaDMb30azuOd/qowXtERTSQHImof3SsJpgnruNOnDv6zR3Yur4bPpOLaFhx+UybnEUmpaGAGsRFNIm3rjLU1Qiqx7TA1ub3BHS+Uzqc88m0err4vlw+Zxtr6fzrtuVezXIHiaauu4Ui/BV64diNsDK7xyknoLOHQcM3DBfwEAAP//30+TnUoHAAA=\n\n- path: \"/opt/azure/containers/kubelet.sh\"\n  permissions: \"0755\"\n  owner: \"root\"\n  content: |\n    #!/bin/bash\n    set -e\n\n\n\n    sed -i \"s|<kubernetesAddonManagerSpec>|',variables('kubernetesAddonManagerSpec'),'|g\" \"/etc/kubernetes/manifests/kube-addon-manager.yaml\"\n    sed -i \"s|<kubernetesHyperkubeSpec>|',variables('kubernetesHyperkubeSpec'),'|g; s|<kubeServiceCidr>|',variables('kubeServiceCidr'),'|g; s|<masterEtcdClientPort>|',variables('masterEtcdClientPort'),'|g; s|<kubernetesAPIServerIP>|',variables('kubernetesAPIServerIP'),'|g\" \"/etc/kubernetes/manifests/kube-apiserver.yaml\"\n    sed -i \"s|<kubernetesHyperkubeSpec>|',variables('kubernetesHyperkubeSpec'),'|g; s|<masterFqdnPrefix>|',variables('masterFqdnPrefix'),'|g; s|<allocateNodeCidrs>|',variables('allocateNodeCidrs'),'|g; s|<kubeClusterCidr>|',variables('kubeClusterCidr'),'|g\" \"/etc/kubernetes/manifests/kube-controller-manager.yaml\"\n    sed -i \"s|<kubernetesHyperkubeSpec>|',variables('kubernetesHyperkubeSpec'),'|g\" \"/etc/kubernetes/manifests/kube-scheduler.yaml\"\n    sed -i \"s|<kubernetesHyperkubeSpec>|',variables('kubernetesHyperkubeSpec'),'|g; s|<kubeClusterCidr>|',variables('kubeClusterCidr'),'|g\" \"/etc/kubernetes/addons/kube-proxy-daemonset.yaml\"\n    sed -i \"s|<kubernetesKubeDNSSpec>|',variables('kubernetesKubeDNSSpec'),'|g; s|<kubernetesDNSMasqSpec>|',variables('kubernetesDNSMasqSpec'),'|g; s|<kubernetesExecHealthzSpec>|',variables('kubernetesExecHealthzSpec'),'|g\" \"/etc/kubernetes/addons/kube-dns-deployment.yaml\"\n    sed -i \"s|<kubernetesHeapsterSpec>|',variables('kubernetesHeapsterSpec'),'|g; s|<kubernetesAddonResizerSpec>|',variables('kubernetesAddonResizerSpec'),'|g\" \"/etc/kubernetes/addons/kube-heapster-deployment.yaml\"\n    sed -i \"s|<kubernetesDashboardSpec>|',variables('kubernetesDashboardSpec'),'|g\" \"/etc/kubernetes/addons/kubernetes-dashboard-deployment.yaml\"\n\n- path: \"/opt/azure/containers/provision.sh\"\n  permissions: \"0744\"\n  encoding: gzip\n  owner: \"root\"\n  content: !!binary |\n    ',variables('provisionScript'),'\n\nruncmd:\n- /bin/echo DAEMON_ARGS=--name \"',variables('masterVMNames')[copyIndex(variables('masterOffset'))],'\" --initial-advertise-peer-urls \"',variables('masterEtcdPeerURLs')[copyIndex(variables('masterOffset'))],'\" --listen-peer-urls \"',variables('masterEtcdPeerURLs')[copyIndex(variables('masterOffset'))],'\" --advertise-client-urls \"',variables('masterEtcdClientURLs')[copyIndex(variables('masterOffset'))],'\" --listen-client-urls \"',concat(variables('masterEtcdClientURLs')[copyIndex(variables('masterOffset'))], ',http://127.0.0.1:', variables('masterEtcdClientPort')),'\" --initial-cluster-token \"k8s-etcd-cluster\" --initial-cluster \"',variables('masterEtcdClusterStates')[div(variables('masterCount'), 2)],' --data-dir \"/var/lib/etcddisk\"\" --initial-cluster-state \"new\" | tee -a /etc/default/etcd\n- sudo /bin/chown -R etcd:etcd /var/lib/etcd/default\n- sudo /bin/chown -R etcd:etcd /var/lib/etcddisk\n- systemctl stop etcd\n- sudo -u etcd rm -rf /var/lib/etcd/default\n- systemctl restart etcd\n- for i in $(seq 1 20); do curl --max-time 60 http://127.0.0.1:2379/v2/machines; [ $? -eq 0 ] && break || sleep 5; done\n- apt-get update\n- apt-get install -y apt-transport-https ca-certificates\n- for i in 1 2 3 4 5; do curl --max-time 60 -fsSL https://aptdocker.azureedge.net/gpg | apt-key add -; [ $? -eq 0 ] && break || sleep 5; done\n- echo \"deb ',variables('dockerEngineDownloadRepo'),' ubuntu-xenial main\" | sudo tee /etc/apt/sources.list.d/docker.list\n- \"echo \\\"Package: docker-engine\\nPin: version ',variables('dockerEngineVersion'),'\\nPin-Priority: 550\\n\\\" > /etc/apt/preferences.d/docker.pref\"\n- apt-get update\n- apt-get install -y ebtables\n- apt-get install -y docker-engine\n- systemctl restart docker\n- mkdir -p /etc/kubernetes/manifests\n- usermod -aG docker ',variables('username'),'\n\n'))]", "linuxConfiguration": {"disablePasswordAuthentication": "true", "ssh": {"publicKeys": [{"keyData": "[variables('sshPublicKeyData')]", "path": "[variables('sshKeyPath')]"}]}}}, "storageProfile": {"dataDisks": [{"createOption": "Empty", "diskSizeGB": "128", "lun": 0, "name": "[concat(variables('masterVMNamePrefix'), copyIndex(variables('masterOffset')),'-etcddisk')]", "vhd": {"uri": "[concat(reference(concat('Microsoft.Storage/storageAccounts/',variables('masterStorageAccountName')),variables('apiVersionStorage')).primaryEndpoints.blob,'vhds/', variables('masterVMNamePrefix'),copyIndex(variables('masterOffset')),'-etcddisk.vhd')]"}}], "imageReference": {"offer": "[variables('osImageOffer')]", "publisher": "[variables('osImagePublisher')]", "sku": "[variables('osImageSku')]", "version": "[variables('osImageVersion')]"}, "osDisk": {"caching": "ReadWrite", "createOption": "FromImage", "name": "[concat(variables('masterVMNamePrefix'), copyIndex(variables('masterOffset')),'-osdisk')]", "vhd": {"uri": "[concat(reference(concat('Microsoft.Storage/storageAccounts/',variables('masterStorageAccountName')),variables('apiVersionStorage')).primaryEndpoints.blob,'vhds/',variables('masterVMNamePrefix'),copyIndex(variables('masterOffset')),'-osdisk.vhd')]"}}}}, "tags": {"creationSource": "[concat('acsengine-', variables('masterVMNamePrefix'), copyIndex(variables('masterOffset')))]", "orchestrator": "[variables('orchestratorNameVersionTag')]", "resourceNameSuffix": "[variables('nameSuffix')]"}, "type": "Microsoft.Compute/virtualMachines"}, {"apiVersion": "[variables('apiVersionDefault')]", "copy": {"count": "[sub(variables('masterCount'), variables('masterOffset'))]", "name": "vmLoopNode"}, "dependsOn": ["[concat('Microsoft.Compute/virtualMachines/', variables('masterVMNamePrefix'), copyIndex(variables('masterOffset')))]"], "location": "[variables('location')]", "name": "[concat(variables('masterVMNamePrefix'), copyIndex(variables('masterOffset')),'/cse', copyIndex(variables('masterOffset')))]", "properties": {"autoUpgradeMinorVersion": true, "protectedSettings": {"commandToExecute": "[concat('/usr/bin/nohup /bin/bash -c \"/bin/bash /opt/azure/containers/provision.sh ',variables('tenantID'),' ',variables('subscriptionId'),' ',variables('resourceGroup'),' ',variables('location'),' ',variables('subnetName'),' ',variables('nsgName'),' ',variables('virtualNetworkName'),' ',variables('routeTableName'),' ',variables('primaryAvailablitySetName'),' ',variables('servicePrincipalClientId'),' ',variables('servicePrincipalClientSecret'),' ',variables('clientPrivateKey'),' ',variables('targetEnvironment'),' ',variables('networkPolicy'),' ',variables('apiServerPrivateKey'),' ',variables('caCertificate'),' ',variables('masterFqdnPrefix'),' ',variables('kubeConfigCertificate'),' ',variables('kubeConfigPrivateKey'),' ',variables('username'),' >> /var/log/azure/cluster-provision.log 2>&1\"')]"}, "publisher": "Microsoft.Azure.Extensions", "settings": {}, "type": "CustomScript", "typeHandlerVersion": "2.0"}, "type": "Microsoft.Compute/virtualMachines/extensions"}], "outputs": {"agentStorageAccountPrefixes": {"type": "array", "value": "[variables('storageAccountPrefixes')]"}, "agentStorageAccountSuffix": {"type": "string", "value": "[variables('storageAccountBaseName')]"}, "agentpool1StorageAccountCount": {"type": "int", "value": "[variables('agentpool1StorageAccountsCount')]"}, "agentpool1StorageAccountOffset": {"type": "int", "value": "[variables('agentpool1StorageAccountOffset')]"}, "masterFQDN": {"type": "string", "value": "[reference(concat('Microsoft.Network/publicIPAddresses/', variables('masterPublicIPAddressName'))).dnsSettings.fqdn]"}}}